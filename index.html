<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPG System - v17 DEF/RES</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;400;600&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
    /* Campo de edi√ß√£o dos Atributos */
.attr-edit-input {
    width: 100%;
    background: transparent !important; /* Remove o fundo branco */
    color: #fff !important;             /* Garante texto branco */
    border: none;
    border-bottom: 2px solid var(--neon-purple); /* Uma linha roxa embaixo pra ficar estiloso */
    text-align: center;
    font-size: 1.8rem;                  /* N√∫mero bem grande */
    font-weight: bold;
    outline: none;                      /* Tira a borda azul padr√£o */
    padding: 5px;
}

    /* Nova classe para o bot√£o de dado (imagem) */
.dice-img {
    width: 32px;
    height: 32px;
    cursor: pointer;
    transition: 0.2s;
    object-fit: contain;
    filter: drop-shadow(0 0 2px var(--neon-purple));
    
    /* ADICIONE ISSO AQUI: */
    flex-shrink: 0;      /* Impede que o flexbox esmague a imagem */
    display: block;      /* Garante o comportamento de bloco */
}

.dice-img:hover {
    transform: scale(1.15) rotate(0deg); /* Gira um pouquinho ao passar o mouse */
    filter: drop-shadow(0 0 8px var(--neon-purple)); /* Brilho mais forte */
}

.dice-img:active {
    transform: scale(0.9); /* Efeito de clique */
}

.menu-btn {
    position: relative; /* OBRIGAT√ìRIO: Segura a imagem dentro do bot√£o */
    display: flex;
    align-items: center; /* Centraliza verticalmente */
    
    /* Cria um espa√ßo seguro na esquerda para a imagem */
    justify-content: flex-start; 
    padding-left: 70px; /* Se a imagem cortar, aumente esse n√∫mero */
    padding-right: 10px;
    
    /* Visual do bot√£o */
    height: 70px; /* Altura fixa */
    background: rgba(255,255,255,0.05); /* Fundo leve */
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    color: #fff;
    cursor: pointer;
    overflow: hidden; /* Garante que nada saia do bot√£o */
}
.btn-icon {
    position: absolute;        /* "Solta" a imagem para mover livremente */
    left: -10px;                /* Cola a imagem no canto esquerdo */
    
    width: 70px;               /* √çcone bem grande */
    height: 70px;
    object-fit: contain;
    
    filter: drop-shadow(0 0 5px var(--neon-purple)); /* Brilho neon */
    opacity: 0.9;              /* Leve transpar√™ncia para estilo */
}
/* --- ESTILO GERAL DO TEXTO --- */
.btn-text {
    position: relative;
    font-size: 0.8rem;
    font-weight: comic sans;
    z-index: 5;
    /* Aqui voc√™ n√£o precisa mexer, use os individuais abaixo */
}
/* --- AJUSTES INDIVIDUAIS (Mova cada texto aqui) --- */
/* Use 'left' para mover lados e 'top' para cima/baixo */

.txt-info      { left: 30px; }
.txt-attrs     { left: 30px; }
.txt-habs      { left: 30px; font-size: 0.7rem; } /* Ex: diminuir fonte */
.txt-combate   { left: 30px; } /* Ex: empurrar pra direita */
.txt-pericias  { left: 30px; }
.txt-oficios   { left: 30px; }
.txt-equips    { left: 30px; font-size: 0.7rem; } /* Ex: puxar pra esquerda */
.txt-inv       { left: 30px; }
    /* ADICIONE ISTO LOGO NO IN√çCIO DO STYLE */
    :root {
        --bg-color: #050505;       /* Cor do fundo (Preto quase total) */
        --neon-purple: #b026ff;    /* O Roxo Neon brilhante */
        --neon-dim: rgba(176, 38, 255, 0.2); /* Roxo transparente para brilhos */
    }

    /* CLASSE PARA O EFEITO NOS BOT√ïES (Adicione isso tamb√©m dentro do style) */
    .btn-glitch {
        color: #fff !important;
        border: 1px solid var(--neon-purple) !important;
        text-shadow: 0 0 5px #000; /* Sombra no texto para leitura */
        box-shadow: 0 0 10px var(--neon-dim); /* Brilho neon externo */
        transition: 0.3s;
        font-weight: bold;
        text-transform: uppercase;
    }
    .btn-glitch:hover {
        box-shadow: 0 0 20px var(--neon-purple); /* Brilho mais forte ao passar o mouse */
        transform: scale(1.02);
    }

    /* ... MANTENHA O RESTO DO SEU CSS ABAIXO ... */

        /* --- CORE --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background-color: #050505; color: #ccc; font-family: 'Montserrat', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        
        /* ICONS */
        .icon-hex { width: 28px; height: 28px; fill: none; stroke: var; stroke-width: 2; cursor: pointer; transition: 0.2s; min-width: 28px; }
        .icon-hex:hover { fill: var; transform: scale(1.1); }
        .icon-hex:active { transform: scale(0.9); }

        /* INPUTS */
        .mod-input { width: 35px; background: transparent; border: 1px solid #333; color: #888; font-size: 0.8rem; text-align: center; border-radius: 4px; padding: 2px; margin-left: auto; }
        .mod-input:focus { border-color: #b026ff; color: #fff; outline: none; }

        /* --- HOME --- */
        #home-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #050505; z-index: 10; display: flex; flex-direction: column; padding: 20px; padding-top: 60px; overflow-y: auto; }
        .room-display { text-align: center; color: #444; font-size: 0.7rem; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; border: 1px solid #222; padding: 5px; border-radius: 20px; width: fit-content; margin-left: auto; margin-right: auto; }
        .btn-new { background: #fff; color: #000; border: none; padding: 15px; width: 100%; border-radius: 50px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 30px; cursor: pointer; transition: 0.2s; }
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; padding-bottom: 80px; }
        .home-card { background: #111; border: 1px solid #333; border-radius: 12px; padding: 20px; position: relative; transition: 0.3s; overflow: hidden; min-height: 160px; background-size: cover; background-position: center; }
        .home-card::before { content:''; position: absolute; top:0; left:0; width:100%; height:100%; background: linear-gradient(to right, rgba(0,0,0,0.9), rgba(0,0,0,0.4)); z-index: 1; }
        .hc-content { position: relative; z-index: 2; }
        .hc-name { font-size: 1.4rem; color: #fff; font-weight: 600; text-transform: uppercase; }
        .hc-class { font-size: 0.8rem; color: #b026ff; text-transform: uppercase; margin-bottom: 10px; display: block;}
        .btn-access { display: inline-block; margin-top: 15px; padding: 8px 20px; border: 1px solid rgba(255,255,255,0.3); color: #fff; border-radius: 20px; font-size: 0.7rem; text-transform: uppercase; cursor: pointer; background: rgba(0,0,0,0.5); }

        /* --- WIZARD --- */
        #wizard-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #080808; z-index: 50; display: none; flex-direction: column; }
        .wiz-nav { display: flex; justify-content: center; padding: 20px; font-size: 0.6rem; letter-spacing: 1px; background: #080808; border-bottom: 1px solid #111; }
        .wn-item { margin: 0 4px; color: #444; } .wn-item.active { color: #fff; font-weight: bold; }
        .wiz-content { flex: 1; overflow-y: auto; padding: 20px; max-width: 800px; margin: 0 auto; width: 100%; }
        .step-view { display: none; } .step-view.active { display: block; animation: fadeIn 0.4s; }
        .wiz-footer { padding: 20px; background: #000; display: flex; gap: 10px; justify-content: center; }
        .btn-wiz-action { padding: 12px 30px; border-radius: 50px; border: 1px solid #444; background: #111; color: #fff; cursor: pointer; text-transform: uppercase; }
        .btn-wiz-action.primary { background: #fff; color: #000; border-color: #fff; font-weight: bold; }
        .attr-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; padding: 15px 0; max-width: 400px; margin: 0 auto; }
        .attr-input { background: transparent; border: 1px solid #333; color: #fff; width: 60px; text-align: center; padding: 5px; font-size: 1.2rem; }
        .cls-card { background: #111; border: 1px solid #333; margin-bottom: 10px; overflow: hidden; transition: 0.3s; border-radius: 6px;}
        .cls-header { padding: 15px; cursor: pointer; display: flex; justify-content: space-between; font-weight: bold; text-transform: uppercase; }
        .cls-body { max-height: 0; overflow: hidden; background: #0a0a0a; transition: max-height 0.4s; padding: 0 15px; }
        .cls-body.open { max-height: 400px; padding: 15px; border-top: 1px solid #333; }
        .btn-pick-cls { width: 100%; padding: 10px; background: #b026ff; color: #000; border: none; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .cls-card.selected { border-color: #b026ff; box-shadow: 0 0 10px rgba(212, 175, 55, 0.2); }
        .list-sel-item { display: flex; justify-content: space-between; align-items: center; background: #111; border-bottom: 1px solid #222; padding: 15px; cursor: pointer; }
        .list-sel-item.active { background: #fff; color: #000; }
        .wiz-form input, .wiz-form textarea { width: 100%; background: transparent; border: none; border-bottom: 1px solid #333; color: #fff; padding: 10px 0; margin-bottom: 20px; font-family: inherit; font-size: 1rem; outline: none; }

        /* --- SHEET --- */
        #sheet-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #050505; z-index: 20; display: none; flex-direction: column; }
        .sheet-header { padding: 20px; display: flex; justify-content: space-between; align-items: flex-start; background: #0a0a0a; border-bottom: 1px solid #222; }
        .sh-info h1 { margin: 0; font-size: 1.2rem; color: #fff; text-transform: uppercase; }
        .sh-info span { font-size: 0.75rem; color: #888; display: block; margin-top: 4px; }
        .sheet-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px;}
        .sheet-view { display: none; } .sheet-view.active { display: block; animation: fadeIn 0.4s; }
        .status-bar-container { margin-bottom: 25px; background: #111; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .progress-track { height: 10px; background: #222; border-radius: 5px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; transition: width 0.3s; }
        .bar-controls { display: flex; gap: 5px; justify-content: space-between; }
        .bar-btn { background: #222; border: 1px solid #444; color: #fff; font-size: 0.65rem; padding: 8px 5px; border-radius: 4px; flex: 1; cursor: pointer; white-space: nowrap; }
        .bar-input { width: 45px; background: #000; border: 1px solid #444; color: #fff; text-align: center; font-size: 0.9rem; border-radius: 4px; }
        .bg-hp { background: #e74c3c; } .bg-mp { background: #3498db; } .bg-cos { background: #9b59b6; } .bg-ki { background: #f1c40f; } .bg-ck { background: #1abc9c; }
        .bg-custom { background: #7f8c8d; }

        /* CARD */
        .item-card { background: #111; border-left: 3px solid #444; padding: 15px; margin-bottom: 10px; position: relative; cursor: pointer; transition: 0.3s; }
        .item-card:hover { background: #161616; }
        .item-card.open { background: #181818; border-left-color: #b026ff; }
        .item-details { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; opacity: 0; }
        .item-card.open .item-details { max-height: 500px; opacity: 1; margin-top: 15px; border-top: 1px dashed #333; padding-top: 10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
        .card-top { display: flex; align-items: center; gap: 15px; } 
        .btn-card-action { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; font-weight: bold; background: none; border: none; padding: 5px 0; margin-right: 15px; }
        .btn-remove { color: #bd1e1e; } .btn-edit { color: #b026ff; } .btn-fav { color: #444; font-size:1.2rem; } .btn-fav.active { color: #b026ff; }
        .btn-add-fancy { width: 100%; padding: 15px; background: #111; border: 1px dashed #444; color: #888; margin-top: 10px; cursor: pointer; text-transform: uppercase; border-radius: 8px; transition: 0.2s; }

        /* MODALS */
        #edit-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 300; display: none; align-items: flex-end; }
        .edit-container { background: #111; width: 100%; max-height: 90%; overflow-y: auto; border-radius: 20px 20px 0 0; border-top: 1px solid #b026ff; padding: 25px; animation: slideUp 0.3s; }
        .edit-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .edit-label { font-size: 0.7rem; color: #666; text-transform: uppercase; display: block; margin-top: 12px; margin-bottom: 5px; }
        .edit-input { width: 100%; background: #080808; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 6px; font-family: inherit; outline: none; }
        .edit-input:focus { border-color: #b026ff; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .extra-dmg-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .btn-del-extra { background: #bd1e1e; color: #fff; border: none; padding: 12px; border-radius: 6px; cursor: pointer; }
        .btn-save-edit { width: 100%; background: #b026ff; color: #000; font-weight: bold; border: none; padding: 15px; margin-top: 20px; border-radius: 8px; cursor: pointer; text-transform: uppercase; }

        /* UI ELEMENTS */
        .fab-menu { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: #b026ff; border-radius: 50%; box-shadow: 0 5px 20px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 100; cursor: pointer; }
        .fab-icon span { display: block; width: 8px; height: 8px; background: #000; margin: 2px; float: left; border-radius: 1px; }
        .fab-history { position: fixed; bottom: 100px; right: 35px; width: 50px; height: 50px; background: #222; border: 1px solid #444; border-radius: 50%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 99; cursor: pointer; transition: 0.2s; color: #888; }
        #toast-container { position: fixed; bottom: 160px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 500; pointer-events: none; }
        .roll-toast { background: rgba(10, 10, 10, 0.95); border-left: 4px solid #b026ff; padding: 15px; border-radius: 6px; min-width: 250px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); animation: slideInRight 0.3s ease; pointer-events: all; backdrop-filter: blur(5px); }
        .toast-title { font-size: 0.7rem; color: #b026ff; text-transform: uppercase; letter-spacing: 1px; }
        .toast-val { font-size: 1.8rem; font-weight: bold; color: #fff; margin: 5px 0; }
        .toast-det { font-size: 0.75rem; color: #888; font-family: monospace; }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        #history-panel { position: fixed; bottom: 100px; right: 95px; width: 280px; max-height: 300px; background: #111; border: 1px solid #333; border-radius: 12px; overflow-y: auto; display: none; flex-direction: column-reverse; padding: 10px; z-index: 300; box-shadow: 0 5px 20px rgba(0,0,0,0.6); }
        .hist-item { border-bottom: 1px solid #222; padding: 10px 0; }
        .hist-item:last-child { border-bottom: none; }
        .hist-time { font-size: 0.6rem; color: #555; display: block; text-align: right; }
        .hist-res { font-size: 0.9rem; color: #ccc; }
        .hist-total { color: #b026ff; font-weight: bold; }
        #menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); z-index: 90; display: none; justify-content: center; align-items: flex-end; padding-bottom: 100px; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 90%; max-width: 400px; }
        .menu-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 20px; color: #fff; text-align: center; border-radius: 12px; text-transform: uppercase; font-size: 0.8rem; cursor: pointer; }
        #add-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 200; display: none; flex-direction: column; justify-content: flex-end; }
        .add-content { background: #111; border-top: 1px solid #333; max-height: 70%; display: flex; flex-direction: column; border-radius: 20px 20px 0 0; padding: 20px; }
        .add-list { overflow-y: auto; flex: 1; }
        .add-item-row { padding: 15px; border-bottom: 1px solid #222; cursor: pointer; color: #ccc; }
        .btn-custom-add { width: 100%; padding: 15px; background: #fff; border: none; color: #000; font-weight: bold; margin-top: 10px; border-radius: 8px; cursor: pointer; }
        #settings-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #151515; padding: 20px; border: 1px solid #444; z-index: 200; width: 90%; max-width: 350px; display: none; border-radius: 12px; }
        .color-dot { 
    height: 40px; 
    border-radius: 8px; /* Deixei um pouco quadrado pra ficar moderno */
    cursor: pointer; 
    border: 1px solid #333;
    transition: 0.2s;
}
.color-dot:hover {
    transform: scale(1.1);
    border-color: #fff;
}
/* Classe para os √≠cones de interface (Editar, Lixo, Voltar) */
.ui-icon {
    width: 24px;       /* Tamanho fixo */
    height: 24px;
    object-fit: contain;
    vertical-align: middle;
    cursor: pointer;
    transition: 0.2s;
    /* Se sua imagem for PNG transparente, isso faz ela brilhar roxo */
    filter: drop-shadow(0 0 2px var(--neon-purple)); 
}

.ui-icon:hover {
    transform: scale(1.2);
    filter: drop-shadow(0 0 5px var(--neon-purple));
}

/* √çcone de Estrela (Favorito) - Precisa de regras especiais para "acender" */
.fav-icon {
    width: 20px;
    height: 20px;
    filter: grayscale(100%); /* Fica cinza quando desativado */
    opacity: 0.5;
}
.fav-icon.active {
    filter: drop-shadow(0 0 5px var(--neon-purple)); /* Brilha quando ativo */
    opacity: 1;
}
/* --- ESTILO DA ABA DE NPCS --- */
.npc-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); /* Se ajusta ao celular */
    gap: 15px;
    padding-bottom: 20px;
}

.npc-card {
    background: #111;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 10px;
    text-align: center;
    transition: 0.3s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
}

.npc-card:hover {
    border-color: var(--neon-purple);
    transform: translateY(-3px);
}

.npc-name {
    display: block;
    font-size: 1.1rem;
    font-weight: 800;          /* Negrito forte */
    color: var(--neon-purple); /* Cor do tema */
    text-transform: uppercase;
    margin-bottom: 10px;
    text-shadow: 0 0 5px rgba(176, 38, 255, 0.4);
    letter-spacing: 1px;
}

/* No seu <style>, garanta que o .npc-img tenha altura */
.npc-img {
    width: 100%;
    height: 180px;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid #333;
    display: block;
    background: #111;
    cursor: pointer;
}

.npc-desc {
    font-size: 0.7rem;
    color: #888;
    margin-top: 8px;
    line-height: 1.4;
}
/* --- ESTILO DOS CEN√ÅRIOS (PLAYER) --- */
.place-card {
    background: #0f0f0f;
    border: 1px solid #333;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}
.place-header {
    padding: 10px; text-align: center; background: #151515; border-bottom: 1px solid #222;
}
.place-name {
    color: #fff; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; font-size: 1rem;
}
.place-img {
    width: 100%;
    height: auto;
    min-height: 180px; /* Garante que a foto ocupe espa√ßo */
    object-fit: cover;
    display: block;
    cursor: pointer;
}
.place-desc {
    padding: 15px; color: #aaa; font-size: 0.85rem; line-height: 1.5; border-top: 1px solid #222;
}

/* Foto do Item (Fica na esquerda) */
.item-thumb {
    width: 45px;
    height: 45px;
    object-fit: cover;       /* Corta a imagem para n√£o esticar */
    border-radius: 8px;      /* Bordas arredondadas */
    border: 1px solid #333;
    flex-shrink: 0;          /* N√£o deixa a imagem ser esmagada */
}

/* Bot√£o de Rolar (Fica na direita) */
.btn-roll-dice {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    margin-left: 5px;
    display: flex;
    align-items: center;
}

/* Imagem do Dado dentro do bot√£o */
.roll-icon {
    width: 30px;
    height: 30px;
    filter: drop-shadow(0 0 2px var(--neon-purple));
    transition: 0.2s;
}
.roll-icon:hover { transform: rotate(180deg) scale(1.1); }
/* Faz o bot√£o ocupar a largura toda do grid (2 colunas) */
.btn-wide {
    grid-column: span 2;
    padding-left: 125px !important; /* Ajuste para o √≠cone n√£o sumir */
}

    </style>
</head>
<body>

    <div id="home-screen">
        <h1 style="text-align:center; font-weight:200; letter-spacing:5px; margin-bottom:10px; color:#fff;">BEM VINDO</h1>
        <button class="btn-new" style="background:transparent; border:1px solid #b026ff; color:#b026ff; margin-bottom:15px;" onclick="openCampModal()">ENTRAR EM CAMPANHA</button>

<div id="camp-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:999; justify-content:center; align-items:center; flex-direction:column;">
    <div style="background:#111; padding:30px; border:1px solid #b026ff; border-radius:12px; text-align:center; width:90%; max-width:350px;">
        <h3 style="color:#fff; margin-top:0;">CONVITE</h3>
        <p style="color:#888; font-size:0.8rem; margin-bottom:20px;">Cole o c√≥digo que o Mestre te mandou:</p>
        
        <input type="text" id="inp-camp-code" placeholder="Ex: MESA-RPG" 
               style="width:100%; padding:15px; background:#000; border:1px solid #333; color:#fff; text-align:center; text-transform:uppercase; font-size:1.2rem; border-radius:6px; margin-bottom:20px; outline:none;">
        
        <button onclick="joinCamp()" style="width:100%; padding:15px; background:#b026ff; color:#000; font-weight:bold; border:none; border-radius:6px; cursor:pointer;">ENTRAR NA SALA</button>
        
        <button onclick="document.getElementById('camp-modal').style.display='none'" style="margin-top:15px; background:none; border:none; color:#bd1e1e; cursor:pointer; font-size:0.8rem;">CANCELAR</button>
    </div>
</div>

        <div class="room-display" id="room-display">...</div>
        <button class="btn-new" onclick="startWizard()">+ Novo Agente</button>
        <div id="home-list" class="char-grid"></div>
    </div>

    <div id="wizard-screen">
        <div class="wiz-nav"><span class="wn-item" id="nav-1">ATRIBUTOS</span>‚Üí<span class="wn-item" id="nav-2">CLASSES</span>‚Üí<span class="wn-item" id="nav-3">OF√çCIOS</span>‚Üí<span class="wn-item" id="nav-4">PER√çCIAS</span>‚Üí<span class="wn-item" id="nav-5">FIM</span></div>
        <div class="wiz-content">
            <div id="step-1" class="step-view active"><h2 style="text-align:center; color:#fff;">ATRIBUTOS</h2><div class="attr-row"><span>FOR</span><input type="number" id="w-for" class="attr-input" value="1"></div><div class="attr-row"><span>AGI</span><input type="number" id="w-agi" class="attr-input" value="1"></div><div class="attr-row"><span>INT</span><input type="number" id="w-int" class="attr-input" value="1"></div><div class="attr-row"><span>VIG</span><input type="number" id="w-vig" class="attr-input" value="1"></div><div class="attr-row"><span>AUR</span><input type="number" id="w-aur" class="attr-input" value="1"></div></div>
            <div id="step-2" class="step-view"><h2 style="text-align:center; color:#fff;">CLASSES</h2><div id="classes-container"></div></div>
            <div id="step-3" class="step-view"><h2 style="text-align:center; color:#fff;">OF√çCIOS</h2><div id="oficios-container"></div></div>
            <div id="step-4" class="step-view"><h2 style="text-align:center; color:#fff;">PER√çCIAS</h2><div id="pericias-container"></div></div>
            <div id="step-5" class="step-view"><h2 style="text-align:center; color:#fff;">TOQUES FINAIS</h2><div class="wiz-form"><input type="text" id="w-player" placeholder="Nome do Jogador"><input type="text" id="w-name" placeholder="Nome do Personagem"><input type="text" id="w-race" placeholder="Ra√ßa"><input type="text" id="w-age" placeholder="Idade"><textarea id="w-hist" placeholder="Hist√≥rico..." rows="5"></textarea></div></div>
        </div>
        <div class="wiz-footer"><button class="btn-wiz-action" onclick="closeWizard()">Cancelar</button><button class="btn-wiz-action primary" id="btn-next" onclick="nextStep()">Pr√≥ximo</button></div>
    </div>

    <div id="sheet-screen">
        <div class="sheet-header">
            <div class="sh-info"><button onclick="closeSheet()" style="background:none; border:none; color:#666; margin-bottom:5px;">‚Üê VOLTAR</button><h1 id="sh-char-name">Nome</h1><span id="sh-player-race">Player</span></div>
                <div style="display:flex; align-items:center; gap: 15px;"> <button onclick="shareChar()" style="background:none; border:none; cursor:pointer; padding:0;">
            <img src="link.png" style="width:55px; height:55px; object-fit:contain; filter:drop-shadow(0 0 4px var(--neon-purple)); vertical-align:middle;">
        </button>
        
        <button onclick="openSettings()" style="background:none; border:none; cursor:pointer; padding:0;">
            <img src="config.png" style="width:55px; height:55px; object-fit:contain; filter:drop-shadow(0 0 4px var(--neon-purple)); vertical-align:middle;">
        </button>

    </div>

        </div>
        <div class="sheet-content">
            <div id="view-info" class="sheet-view active"><h2 style="border-bottom:1px solid #333;">Dossi√™</h2><p id="sh-hist" style="color:#aaa; line-height:1.6;"></p><div style="background:#111; padding:20px; border-radius:8px; margin-top:20px;"><span style="color:#b026ff; font-size:1.2rem; display:block; margin-bottom:5px;" id="sh-class">Classe</span><span style="color:#fff;" id="sh-origem">Origem</span></div></div>
            <div id="view-atributos" class="sheet-view">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
    <h3>Atributos Base</h3>
    
    <button onclick="toggleAttrEdit()" style="background:none; border:none; cursor:pointer; padding:5px;">
        <img id="img-attr-toggle" src="lapis.png" class="ui-icon" 
             style="width: 75px; height: 75px; object-fit: contain;">
    </button>
</div>
<div id="base-attrs" style="display:grid; grid-template-columns:repeat(5,1fr); gap:5px; text-align:center; margin-bottom: 20px;"></div>
                
                <div style="display:flex; justify-content:space-between; align-items:flex-end; border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:15px; margin-top:20px;">
                    <h3 style="margin:0;">Reservas Vitais</h3>
                    <div style="display:flex; gap:10px;">
                        <div style="text-align:center;">
                            <small style="font-size:0.6rem; color:#888; display:block; margin-bottom:2px;">N√çVEL</small>
                            <input type="number" id="inp-level" style="width:50px; background:#111; border:1px solid #444; color:#fff; text-align:center; padding:5px; border-radius:4px;" onchange="updateLevel(this.value)">
                        </div>
                        <div style="text-align:center;">
                            <small style="font-size:0.6rem; color:#888; display:block; margin-bottom:2px;">XP</small>
                            <input type="text" id="inp-xp" style="width:60px; background:#111; border:1px solid #444; color:#fff; text-align:center; padding:5px; border-radius:4px;" onchange="updateXP(this.value)">
                        </div>
                    </div>
                </div>

                <div id="bars-container"></div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                    <div style="background:#111; border:1px solid #333; padding:10px; border-radius:8px; text-align:center;">
                        <small style="color:#888; font-size:0.7rem; display:block;">DEFESA</small>
                        <input type="number" id="inp-def" style="font-size:1.5rem; width:100%; background:transparent; border:none; color:#fff; text-align:center; font-weight:bold;" onchange="updateStat('def',this.value)">
                    </div>
                    <div style="background:#111; border:1px solid #333; padding:10px; border-radius:8px; text-align:center;">
                        <small style="color:#888; font-size:0.7rem; display:block;">RESIST√äNCIA</small>
                        <input type="number" id="inp-res" style="font-size:1.5rem; width:100%; background:transparent; border:none; color:#fff; text-align:center; font-weight:bold;" onchange="updateStat('res',this.value)">
                    </div>
                </div>

                <div id="custom-bars-container"></div>
                <button class="btn-add-fancy" onclick="addCustomBar()" style="margin-top:15px;">+ Nova Barra</button>
            </div>
            
            <div id="view-habilidades" class="sheet-view"><h3>Habilidades</h3><div id="list-habilidades"></div><button class="btn-add-fancy" onclick="openAddModal('habilidades')">+ Adicionar Habilidade</button></div>
            <div id="view-combate" class="sheet-view"><h3>Favoritos</h3><div id="list-favs"></div></div>
            <div id="view-pericias" class="sheet-view"><h3>Per√≠cias</h3><div id="list-pericias"></div><button class="btn-add-fancy" onclick="openAddModal('pericias')">+ Adicionar Per√≠cia</button></div>
            <div id="view-oficios" class="sheet-view"><h3>Of√≠cios</h3><div id="list-oficios"></div><button class="btn-add-fancy" onclick="openAddModal('oficios')">+ Adicionar Of√≠cio</button></div>
            <div id="view-equipamentos" class="sheet-view"><h3>Equipamentos</h3><div id="list-equipamentos"></div><button class="btn-add-fancy" onclick="openAddModal('equipamentos')">+ Adicionar Equipamento</button></div>
            <div id="view-itens" class="sheet-view"><h3>Invent√°rio</h3><div id="list-itens"></div><button class="btn-add-fancy" onclick="openAddModal('itens')">+ Adicionar Item</button></div>
                <div id="view-npcs" class="sheet-view">
        <h3 style="border-bottom:1px solid #333; padding-bottom:10px;">NPCs & CEN√ÅRIOS</h3>
        <div id="list-npcs" class="npc-grid">
            <p style="color:#666; font-size:0.8rem; width:100%;">Carregando dados do Mestre...</p>

   </div>

        </div>
    </div>

        </div>

        <div id="toast-container"></div>
        <div id="history-panel"></div>
        
        <div class="fab-history" onclick="toggleHistory()">
            <svg style="width:24px;height:24px;fill:none;stroke:currentColor;stroke-width:2" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        </div>
        
        <div class="fab-menu" onclick="toggleMenu()"><div class="fab-icon" style="width:24px;"><span></span><span></span><span></span><span></span></div></div>
    </div>

    <div id="add-modal"><div class="add-content"><div class="add-header"><h3 style="margin:0;" id="add-title">Adicionar</h3><button onclick="document.getElementById('add-modal').style.display='none'" style="background:none; border:none; color:#fff; font-size:1.5rem;">&times;</button></div><div id="add-list-content" class="add-list"></div><button class="btn-custom-add" onclick="addCustomItem()">Criar Personalizado</button></div></div>

     <div id="edit-modal">
        <div class="edit-container">
            <div class="edit-header">
                <h3 style="margin:0; color:#b026ff;">EDITAR ITEM</h3>
                <button onclick="document.getElementById('edit-modal').style.display='none'" style="background:none; border:none;"
                </button>
            </div>
            
            <label class="edit-label">Nome</label>
            <input type="text" id="ed-name" class="edit-input">
            
            <div class="grid-2">
                <div><label class="edit-label">Dano / Efeito</label><input type="text" id="ed-dmg" class="edit-input"></div>
                <div><label class="edit-label">Cr√≠tico</label><input type="text" id="ed-crit" class="edit-input"></div>
            </div>
            
            <div class="grid-2">
                <div><label class="edit-label">Tipo</label><input type="text" id="ed-type" class="edit-input"></div>
                <div><label class="edit-label">Alcance</label><input type="text" id="ed-range" class="edit-input"></div>
            </div>

            <label class="edit-label" style="color:#b026ff; margin-top:15px;">IMAGEM / √çCONE</label>
            
            <label for="item-upload-input" id="lbl-item-upload" style="display:block; width:100%; padding:12px; background:#222; border:1px dashed #555; color:#ccc; text-align:center; cursor:pointer; border-radius:6px; margin-bottom:5px;">
                üìÅ Escolher da Galeria
            </label>
            <input type="file" id="item-upload-input" accept="image/*" style="display:none;" onchange="uploadImagemItem(this)">

            <input type="text" id="ed-img" class="edit-input" placeholder="...ou cole o Link aqui" style="font-size:0.7rem; color:#888;">

            <label class="edit-label">Notas / Descri√ß√£o</label>
            <textarea id="ed-notes" class="edit-input" rows="3"></textarea>
            
            <div style="margin-top:20px; border-top:1px dashed #333; padding-top:10px;">
                <label class="edit-label" style="color:#b026ff; font-size:0.9rem;">DADOS EXTRAS</label>
                <div id="extra-dmg-list"></div>
                <button onclick="addExtraDmgField()" style="background:#222; border:1px solid #444; color:#ccc; padding:8px; width:100%; border-radius:4px; margin-top:5px;">+ Adicionar Dado</button>
            </div>
            
            <button class="btn-save-edit" onclick="saveEdit()">SALVAR ALTERA√á√ïES</button>
        </div>
    </div>


    <div id="menu-overlay" onclick="toggleMenu()"><div class="menu-grid" onclick="event.stopPropagation()">
    
    <div class="menu-btn" onclick="navTo('info')">
        <img src="info.png" class="btn-icon">
        <span class="btn-text txt-info">INFO</span>
    </div>

    <div class="menu-btn" onclick="navTo('atributos')">
        <img src="atributos.png" class="btn-icon">
        <span class="btn-text txt-attrs">ATRIBUTOS</span>
    </div>

    <div class="menu-btn" onclick="navTo('habilidades')">
        <img src="habilidades.png" class="btn-icon">
        <span class="btn-text txt-habs">HABILIDADES</span>
    </div>

    <div class="menu-btn" onclick="navTo('combate')">
        <img src="combate.png" class="btn-icon">
        <span class="btn-text txt-combate">COMBATE</span>
    </div>

    <div class="menu-btn" onclick="navTo('pericias')">
        <img src="pericia.png" class="btn-icon">
        <span class="btn-text txt-pericias">PER√çCIAS</span>
    </div>

    <div class="menu-btn" onclick="navTo('oficios')">
        <img src="oficio.png" class="btn-icon">
        <span class="btn-text txt-oficios">OF√çCIOS</span>
    </div>

    <div class="menu-btn" onclick="navTo('equipamentos')">
        <img src="equipamento.png" class="btn-icon">
        <span class="btn-text txt-equips">EQUIPAMENTOS</span>
    </div>

    <div class="menu-btn" onclick="navTo('itens')">
        <img src="inventario.png" class="btn-icon">
        <span class="btn-text txt-inv">INVENT√ÅRIO</span>
    </div>
    <div class="menu-btn btn-wide" onclick="navTo('npcs')">
    <img src="npc.png" class="btn-icon">
    <span class="btn-text">NPCs e CEN√ÅRIOS</span>
</div>

    
    </div></div><div id="settings-modal">
        <h3 style="color:#fff; border-bottom:1px solid #333; padding-bottom:10px; margin-top:0;">PERSONALIZAR</h3>
        
        <label class="edit-label" style="margin-top:15px; display:block; color:#888;">Cor do Tema</label>
        <div id="color-opts" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-bottom:20px;">
            <span class="color-dot" style="background:#b026ff; width:100%; height:40px; border-radius:8px; border:1px solid #333;" onclick="setTheme('#b026ff')"></span>
            <span class="color-dot" style="background:#e74c3c; width:100%; height:40px; border-radius:8px; border:1px solid #333;" onclick="setTheme('#e74c3c')"></span>
            <span class="color-dot" style="background:#3498db; width:100%; height:40px; border-radius:8px; border:1px solid #333;" onclick="setTheme('#3498db')"></span>
            <span class="color-dot" style="background:#2ecc71; width:100%; height:40px; border-radius:8px; border:1px solid #333;" onclick="setTheme('#2ecc71')"></span>
            <span class="color-dot" style="background:#e67e22; width:100%; height:40px; border-radius:8px; border:1px solid #333;" onclick="setTheme('#e67e22')"></span>
            <span class="color-dot" style="background:#00d2d3; width:100%; height:40px; border-radius:8px; border:1px solid #333;" onclick="setTheme('#00d2d3')"></span>
            <span class="color-dot" style="background:#ff6b81; width:100%; height:40px; border-radius:8px; border:1px solid #333;" onclick="setTheme('#ff6b81')"></span>
            <span class="color-dot" style="background:#bdc3c7; width:100%; height:40px; border-radius:8px; border:1px solid #333;" onclick="setTheme('#bdc3c7')"></span>
        </div>

        <label class="edit-label" style="display:block; color:#888;">Imagem de Fundo</label>
        
        <label for="file-upload" id="lbl-upload" style="display:block; width:100%; padding:15px; background:#222; border:1px dashed #555; color:#ccc; text-align:center; cursor:pointer; border-radius:8px; margin-bottom:10px; margin-top:5px;">
            üìÅ Escolher da Galeria
        </label>
        <input type="file" id="file-upload" accept="image/*" style="display:none;" onchange="uploadImagemGaleria(this)">

        <p style="text-align:center; color:#666; font-size:0.8rem; margin:5px 0;">OU use um Link:</p>
        <input type="text" id="img-input" placeholder="Cole a URL da imagem aqui..." style="width:100%; background:#000; color:#fff; border:1px solid #333; padding:10px; border-radius:5px;" onchange="setBg(this.value)">

        <button onclick="document.getElementById('settings-modal').style.display='none'" 
                style="margin-top:20px; width:100%; padding:12px; background:var(--neon-purple); color:#000; font-weight:bold; border:none; border-radius:5px; cursor:pointer;">
                CONCLUIR
        </button>
    </div>

    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDKxt0jilkvGj0kDIpXlktHih_n_2qDKY0",
            authDomain: "meu-sistema-9ffe4.firebaseapp.com",
            databaseURL: "https://meu-sistema-9ffe4-default-rtdb.firebaseio.com",
            projectId: "meu-sistema-9ffe4",
            storageBucket: "meu-sistema-9ffe4.firebasestorage.app",
            messagingSenderId: "603836576137",
            appId: "1:603836576137:web:d6bbce12dc7b17cafb3158",
            measurementId: "G-7DSHNMYYM5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- VARIAVEIS ---
        let chars = [];
        let activeId = null;
        let currentAddType = '';
        let attrEditMode = false;
        let editingList = '', editingIndex = -1;
        let rollHistory = []; 
        let roomCode = localStorage.getItem('rpg_room_code_v14');
        let dbRef = null;
        let npcs = []; // Vari√°vel global para guardar a lista
        let cenarios = [];

    // --- SUAS IMAGENS AQUI ---
// Troque os nomes abaixo pelos nomes dos arquivos que est√£o na sua pasta
const MEUS_ICONES = {
    editar: "lapis.png",       // Imagem de editar/l√°pis
    lixo: "lixeira.png",       // Imagem da lixeira
    favorito: "‚òÖ",   // Imagem da estrela/favorito
    dado: "d20.png"            // Imagem do dado (para rolar)
};


        // --- DB ---
        const classesDB = [{n:'Mago', s:{mp:25, hp:-15}}, {n:'Cavaleiro', s:{hp:25}}, {n:'Cavaleiro Sagrado', s:{hp:35, cos:25}}, {n:'B√°rbaro', s:{hp:10, mp:-15, ck:5}}, {n:'Samurai', s:{ki:15, mp:-10}}, {n:'Monje', s:{hp:10, ck:10, cos:5}}, {n:'Elegante', s:{mp:15}}, {n:'Ceifeiro', s:{hp:25, mp:15}}, {n:'Bruxo', s:{mp:30, hp:-10}}, {n:'Arcano', s:{hp:25, mp:10}}, {n:'Obscuro', s:{hp:15, mp:15}}, {n:'Fabricante', s:{hp:10}}, {n:'Contratante Espiritual', s:{mp:35}}, {n:'Ca√ßador Apurado', s:{}}, {n:'Cantor Andarilho', s:{ck:40}}];
        const oficiosDB = ['Ferreiro (FOR)', 'Armeiro (FOR)', 'Lenhador (FOR)', 'Marceneiro (FOR)', 'Minerador (FOR)', 'Alfaiate (AGI)', 'Ca√ßador (AGI)', 'Ladr√£o (AGI)', 'Joalheiro (AGI)', 'Artes√£os (INT)', 'Cozinheiro (INT)', 'Alquimista (INT)', 'Herbalista (INT)', 'Aluno (INT)', 'Mec√¢nica (INT)', 'Nobre (AUR)', 'Professor (AUR)', 'Mercador (AUR)'];
        const periciasDB = ['Ci√™ncias (INT)', 'Medicina (INT)', 'Cosmologia (INT)', 'T√°tica (INT)', 'Conhecimento (INT)', 'Mem√≥ria (INT)', 'Sobreviv√™ncia (INT)', 'Misticismo (INT)', 'Fortitude (VIG)', 'Medita√ß√£o (VIG)', 'Atletismo (VIG)', 'Descanso (VIG)', 'Vontade (VIG)', 'Poder (AUR)', 'Percep√ß√£o (AUR)', 'Ocultar-se (AUR)', 'Intimidar (AUR)', 'Seduzir (AUR)', 'For√ßa (FOR)', 'Arremessar (FOR)', 'Escalar (FOR)', 'Bloquear (FOR)', 'Luta (FOR/AGI)', 'Iniciativa (AGI)', 'Acrobacia (AGI)', 'Dan√ßa (AGI)', 'Roubo (AGI)', 'Pilotagem (AGI)', 'Furtividade (AGI)', 'Reflexos (AGI)', 'Pontaria (AGI)'];
        const generalItemsDB = { habilidades: ['Ataque B√°sico', 'Esquiva', 'Cura Menor', 'Bola de Fogo'], equipamentos: ['Espada Curta', 'Armadura de Couro', 'Po√ß√£o de Cura'], itens: ['Tocha', 'Corda', 'Ra√ß√µes'] };

        // --- INIT ---
                window.onload = () => {
            if(!roomCode) {
                roomCode = prompt("Nome da Sala (Multiplayer):") || 'Lobby';
                localStorage.setItem('rpg_room_code_v14', roomCode);
            }
            // Verifica se o elemento existe antes de escrever nele
            const roomDisplay = document.getElementById('room-display');
            if(roomDisplay) roomDisplay.innerText = roomCode;
            
            dbRef = db.ref('rpg_rooms/' + roomCode);
            
            // ESCUTA PERSONAGENS
            dbRef.child('chars').on('value', (snapshot) => {
                const data = snapshot.val();
                // Convers√£o segura: se vier objeto, vira array. Se for nulo, vira []
                chars = data ? (Array.isArray(data) ? data : Object.values(data)) : [];
                
                renderHome();
                
                if(activeId) {
                    const c = getActive();
                    if(c) {
                        calcMax(c);
                        const activeView = document.querySelector('.sheet-view.active');
                        if(activeView && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                            const vId = activeView.id.replace('view-', '');
                            if(vId === 'atributos') renderAttrs();
                            else if(['habilidades','pericias','oficios','equipamentos','itens'].includes(vId)) renderList(vId);
                            else if(vId === 'combate') renderFavs();
                        }
                    } else {
                        closeSheet();
                    }
                }
            });

                    // --- OUVINTE UNIFICADO (NPCs + CEN√ÅRIOS) ---
        
        // Escuta NPCs
        dbRef.child('npcs').on('value', (snapshot) => {
            const data = snapshot.val();
            npcs = data ? (Array.isArray(data) ? data : Object.values(data)) : [];
            renderGmData(); // Chama a fun√ß√£o unificada
        });

        // Escuta Cen√°rios e joga na mesma lista
        dbRef.child('cenarios').on('value', (snapshot) => {
            const data = snapshot.val();
            cenarios = data ? (Array.isArray(data) ? data : Object.values(data)) : [];
            renderGmData(); // Chama a fun√ß√£o unificada
        });

            // ESCUTA ROLAGENS
            dbRef.child('rolls').limitToLast(1).on('child_added', (snapshot) => {
                const r = snapshot.val();
                if(Date.now() - r.id < 5000) { 
                    showToast(r);
                    if(typeof rollHistory !== 'undefined') {
                        rollHistory.push(r);
                        updateHistoryPanel();
                    }
                }
            });

            if(typeof setupWizard === 'function') setupWizard();
        };


        function save() { if(chars) dbRef.child('chars').set(chars).catch(e => console.error(e)); }
        function getActive() { return chars.find(x => x.id == activeId); }

        // --- ROLLS ---
        function registerRoll(title, total, details) { dbRef.child('rolls').push({ id: Date.now(), title, total, details, time: new Date().toLocaleTimeString() }); }
        function showToast(data) {
    // SEGURAN√áA: Se a rolagem for oculta (hidden) e eu n√£o sou o Mestre, ignora!
    // (Ou seja, n√£o mostra nada na tela do jogador)
    if(data.hidden && !isGM) return; 

    const container = document.getElementById('toast-container');
    const el = document.createElement('div'); 
    el.className = 'roll-toast';
    
    // Se for Mestre vendo um dado oculto, pinta de vermelho pra ele saber
    let style = "";
    let icon = "";
    if(data.hidden) {
        style = "border-left-color: #bd1e1e;";
        icon = "üëÅÔ∏è‚Äçüó®Ô∏è (OCULTO) ";
    }

    el.style = style;
    el.innerHTML = `
        <div class="toast-title" style="${data.hidden ? 'color:#bd1e1e' : ''}">
            ${icon}${data.title}
        </div>
        <div class="toast-val">${data.total}</div>
        <div class="toast-det">${data.details}</div>
    `;
    
    container.appendChild(el);
    
    // Some depois de 4 segundos
    setTimeout(() => { 
        el.style.animation = 'fadeOut 0.5s ease forwards'; 
        setTimeout(() => el.remove(), 500); 
    }, 4000);
}

        function rollDice(notation) {
            if(!notation) return {total:0, details:[]};
            let parts = notation.toLowerCase().split('+'); let total = 0, details = [];
            parts.forEach(p => {
                p = p.trim();
                if(p.includes('d')) {
                    let [n, s] = p.split('d'); n = parseInt(n)||1; s = parseInt(s);
                    let subRes = []; for(let i=0; i<n; i++) { let r = Math.floor(Math.random()*s)+1; subRes.push(r); total += r; }
                    details.push(`${n}d${s}: [${subRes.join(', ')}]`);
                } else if(!isNaN(parseInt(p))) { let v = parseInt(p); total += v; details.push(`Mod: ${v}`); }
            });
            return { total, details };
        }
        function rollAttr(name, val) {
            let res = []; for(let i=0; i<val; i++) res.push(Math.floor(Math.random()*10)+1);
            registerRoll(name.toUpperCase(), "---", res.map(x=>`[${x}]`).join(' '));
        }
        function rollItem(type, index) {
            const item = getActive().lists[type][index];
            const manualMod = parseInt(item.mod) || 0;
            if(type === 'pericias' || type === 'oficios') {
                let mod = 0; let attrName = "---";
                const match = item.n.match(/\((.*?)\)/);
                if(match) { attrName = match[1].toLowerCase(); if(getActive().attrs[attrName]) mod = getActive().attrs[attrName]; }
                let d10 = Math.floor(Math.random()*10)+1;
                let total = d10 + mod + manualMod;
                registerRoll(item.n, total, `1d10(${d10}) + ${attrName.toUpperCase()}(${mod}) + Mod(${manualMod})`);
                return;
            }
            if(item.dmg) {
                let total = 0; let details = [];
                let r1 = rollDice(item.dmg); total += r1.total; details.push(`${item.dmg}: ${r1.total}`);
                if(item.extraDmg) { item.extraDmg.forEach(ex => { let r2 = rollDice(ex.dice); total += r2.total; details.push(`${ex.type} (${ex.dice}): ${r2.total}`); }); }
                if(manualMod !== 0) { total += manualMod; details.push(`Mod: ${manualMod}`); }
                registerRoll("DANO TOTAL", total, details.join(' + '));
                return;
            }
            alert("Item sem dados de rolagem.");
        }

        // --- UI ---
        function renderHome() {
            const grid = document.getElementById('home-list'); grid.innerHTML = '';
            if(!chars) chars = [];
            chars.forEach(c => {
                const el = document.createElement('div'); el.className = 'home-card';
                if(c.bg) el.style.backgroundImage = `url('${c.bg}')`; el.style.borderColor = c.color || '#333';
                el.innerHTML = `<div class="hc-content"><button style="position:absolute; right:0; top:0; background:none; border:none; color:red; cursor:pointer;" onclick="delChar(${c.id}, event)">√ó</button><span class="hc-class" style="color:${c.color||'#b026ff'}">${c.classe}</span><div class="hc-name">${c.name}</div><div style="font-size:0.8rem; color:#ccc;">${c.player}</div><button class="btn-access" onclick="openSheet(${c.id})">Acessar</button></div>`;
                grid.appendChild(el);
            });
        }
        function delChar(id, e) { e.stopPropagation(); if(confirm("Apagar personagem?")) { chars = chars.filter(c=>c.id!=id); save(); renderHome(); } }
        function toggleHistory() { const p = document.getElementById('history-panel'); p.style.display = (p.style.display === 'flex') ? 'none' : 'flex'; }
        function updateHistoryPanel() {
            const p = document.getElementById('history-panel'); p.innerHTML = '';
            if(rollHistory.length === 0) { p.innerHTML = '<div style="color:#666; font-size:0.8rem; text-align:center;">Vazio.</div>'; return; }
            rollHistory.slice().reverse().forEach(r => { 
                p.innerHTML += `<div class="hist-item"><span class="hist-time">${r.time}</span><div style="font-size:0.8rem; color:#d4af37; text-transform:uppercase;">${r.title}</div><div class="hist-res">Total: <span class="hist-total">${r.total}</span></div><div style="font-size:0.7rem; color:#666;">${r.details}</div></div>`;
            });
        }

        // --- WIZARD ---
        let wizStep=1, tempChar={classe:null,oficios:[],pericias:[]};
        function startWizard(){document.getElementById('home-screen').style.display='none';document.getElementById('wizard-screen').style.display='flex';wizStep=1;updateWizUI();setupWizard();}
        function setupWizard(){
            const cc=document.getElementById('classes-container'); cc.innerHTML=''; classesDB.forEach((c,i)=>{ cc.innerHTML+=`<div class="cls-card" id="cls-${i}"><div class="cls-header" onclick="this.nextElementSibling.classList.toggle('open')"><span>${c.n}</span><span>+</span></div><div class="cls-body"><button class="btn-pick-cls" onclick="pickCls('${c.n}',${i})">Selecionar</button></div></div>`});
            renderSelList(oficiosDB,'oficios-container','oficios'); renderSelList(periciasDB,'pericias-container','pericias');
        }
        function pickCls(n,i){ tempChar.classe=n; document.querySelectorAll('.cls-card').forEach(x=>x.classList.remove('selected')); document.getElementById(`cls-${i}`).classList.add('selected');}
        function renderSelList(db,id,k){const c=document.getElementById(id);c.innerHTML='';db.forEach(i=>{c.innerHTML+=`<div class="list-sel-item" onclick="this.classList.toggle('active'); toggleArr('${k}','${i}')"><span>${i}</span><div class="check-circle"></div></div>`})}
        function toggleArr(k,v){if(tempChar[k].includes(v))tempChar[k]=tempChar[k].filter(x=>x!==v);else tempChar[k].push(v);}
        function updateWizUI(){document.querySelectorAll('.step-view').forEach(v=>v.classList.remove('active'));document.getElementById(`step-${wizStep}`).classList.add('active');}
        function nextStep(){ if(wizStep<5){wizStep++;updateWizUI();}else finishChar(); }
        function finishChar(){
            const newChar={id:Date.now(), name:document.getElementById('w-name').value, player:document.getElementById('w-player').value, race:document.getElementById('w-race').value, hist:document.getElementById('w-hist').value, age:document.getElementById('w-age').value, classe:tempChar.classe, stats:{hp:{c:25,b:0},mp:{c:15,b:0},cos:{c:0,b:0},ki:{c:0,b:0},ck:{c:0,b:0}, level:1, xp:0, def:0, res:0}, attrs:{for:parseInt(document.getElementById('w-for').value)||1, agi:parseInt(document.getElementById('w-agi').value)||1, int:parseInt(document.getElementById('w-int').value)||1, vig:parseInt(document.getElementById('w-vig').value)||1, aur:parseInt(document.getElementById('w-aur').value)||1}, lists:{habilidades:[],pericias:tempChar.pericias.map(p=>({n:p,fav:false})),oficios:tempChar.oficios.map(o=>({n:o,fav:false})),equipamentos:[],itens:[]}, color:'#b026ff'};
            calcMax(newChar); ['hp','mp','cos','ki','ck'].forEach(k=>newChar.stats[k].c=newChar.calculatedMax[k]);
            if(!chars) chars = []; chars.push(newChar); save(); document.getElementById('wizard-screen').style.display='none'; document.getElementById('home-screen').style.display='flex'; renderHome();
        }
        function closeWizard() { document.getElementById('wizard-screen').style.display='none'; document.getElementById('home-screen').style.display='flex'; }

        // --- SHEET ---
        function calcMax(c) {
            const cls=classesDB.find(x=>x.n===c.classe)||{s:{}}; const cm=cls.s;
            c.calculatedMax={
                hp:25+(c.attrs.vig*10)+(cm.hp||0)+(c.stats.hp.b||0), mp:15+(c.attrs.int*20)+(cm.mp||0)+(c.stats.mp.b||0),
                cos:(c.attrs.int*10)+(c.attrs.aur*10)+(cm.cos||0)+(c.stats.cos.b||0), ki:(c.attrs.for*10)+(cm.ki||0)+(c.stats.ki.b||0), ck:(c.attrs.aur*10)+(cm.ck||0)+(c.stats.ck.b||0)
            };
        }
        function openSheet(id) {
    activeId = id;
    document.getElementById('home-screen').style.display = 'none';
    document.getElementById('sheet-screen').style.display = 'flex';
    
    // MOSTRA os bot√µes flutuantes
    document.querySelector('.fab-menu').style.setProperty('display', 'flex', 'important');
    document.querySelector('.fab-history').style.setProperty('display', 'flex', 'important');
    
    renderSheet(getActive());
    navTo('info'); // Abre na aba info por padr√£o
}

function closeSheet() {
    activeId = null;
    document.getElementById('sheet-screen').style.display = 'none';
    document.getElementById('home-screen').style.display = 'flex';
    
    // ESCONDE os bot√µes flutuantes
    document.querySelector('.fab-menu').style.setProperty('display', 'none', 'important');
    document.querySelector('.fab-history').style.setProperty('display', 'none', 'important');
    
    // Garante que o painel de hist√≥rico tamb√©m feche
    document.getElementById('history-panel').style.display = 'none';
}

     function navTo(v) { 
    // Remove o 'active' de todas as abas
    document.querySelectorAll('.sheet-view').forEach(e => e.classList.remove('active')); 
    
    // Ativa a aba desejada
    const target = document.getElementById('view-' + v);
    if(target) {
        target.classList.add('active'); 
    } else if (v === 'npcs') {
        // Caso o ID seja diferente (ex: view-npcs)
        document.getElementById('view-npcs').classList.add('active');
    }
    
    // Se for a aba unificada, renderiza os dados
    if (v === 'npcs') {
        renderGmData();
    }
    
    // FECHA O MENU AUTOMATICAMENTE
    toggleMenu(); 
}

        function toggleMenu(){const m=document.getElementById('menu-overlay');m.style.display=(m.style.display==='flex')?'none':'flex';}
       function toggleAttrEdit() { 
    attrEditMode = !attrEditMode; 
    
    // Pega a imagem pelo ID que criamos no HTML
    const img = document.getElementById('img-attr-toggle');
    
    // Se estiver editando (attrEditMode √© verdadeiro), mostra o DISQUETE.
    // Se n√£o, mostra o L√ÅPIS.
    img.src = attrEditMode ? "disquete.png" : "lapis.png";
    
    // Salva e recalcula se estiver saindo do modo de edi√ß√£o
    if(!attrEditMode) { 
        calcMax(getActive()); 
        save(); 
    } 
    
    renderAttrs(); 
}

        function renderAttrs() {
    const c = getActive(); 
    calcMax(c); 
    
    // Atualiza Level e XP
    document.getElementById('inp-level').value = c.stats.level || 1;
    document.getElementById('inp-xp').value = c.stats.xp || 0;

    const baseDiv = document.getElementById('base-attrs'); 
    baseDiv.innerHTML = '';
    
    Object.entries(c.attrs).forEach(([k,v]) => {
        if(attrEditMode) {
            // MODO EDI√á√ÉO (Usando a nova classe que corrige o fundo branco)
            baseDiv.innerHTML += `
                <div style="background:#111; padding:10px; border:1px solid var(--neon-purple); border-radius:8px;">
                    <input type="number" value="${v}" class="attr-edit-input" onchange="updateAttr('${k}',this.value)">
                    <div style="font-size:0.7rem; color:#888; margin-top:5px; font-weight:bold;">${k.toUpperCase()}</div>
                </div>`;
        } else {
            // MODO VISUALIZA√á√ÉO (Normal)
            baseDiv.innerHTML += `
                <div style="background:#111; padding:10px; border:1px solid #333; border-radius:8px; cursor:pointer; transition:0.2s;" onclick="rollAttr('${k}', ${v})">
                    <div style="font-size:1.8rem; font-weight:bold; color:#fff;">${v}</div>
                    <div style="font-size:0.7rem; color:#888; font-weight:bold;">${k.toUpperCase()}</div>
                </div>`;
        }
    });          
            const barsDiv = document.getElementById('bars-container'); barsDiv.innerHTML = '';
    ['hp','mp','cos','ki','ck'].forEach(k => { const max = c.calculatedMax[k]; if(max>0) { const curr = c.stats[k].c; const pct = Math.min(100, Math.max(0,(curr/max)*100)); barsDiv.innerHTML += `<div class="status-bar-container"><div style="display:flex; justify-content:space-between; font-size:0.8rem;"><b>${k.toUpperCase()}</b><span>${curr}/${max}</span></div><div class="progress-track"><div class="progress-fill bg-${k}" style="width:${pct}%"></div></div><div class="bar-controls"><button class="bar-btn" onclick="modMax('${k}',-10)">-10 Max</button><button class="bar-btn" onclick="modCurr('${k}',-10)">-10</button><input type="number" class="bar-input" value="${curr}" onchange="setCurr('${k}',this.value)"><button class="bar-btn" onclick="modCurr('${k}',10)">+10</button><button class="bar-btn" onclick="modMax('${k}',10)">+10 Max</button></div></div>`; }});
    
    document.getElementById('inp-def').value = c.stats.def || 0;
    document.getElementById('inp-res').value = c.stats.res || 0;

    const customDiv = document.getElementById('custom-bars-container'); customDiv.innerHTML = '';
    if(c.customBars) {
        c.customBars.forEach((b, i) => {
            const pct = Math.min(100, Math.max(0, (b.c/b.m)*100));
            customDiv.innerHTML += `
                <div class="status-bar-container" style="border-color:#555;">
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem;">
                        <b>${b.n}</b>
                        <div>
                            <span style="margin-right:10px;">${b.c}/${b.m}</span>
                            <button style="background:none; border:none; color:#bd1e1e; cursor:pointer;" onclick="removeCustomBar(${i})">√ó</button>
                        </div>
                    </div>
                    <div class="progress-track"><div class="progress-fill bg-custom" style="width:${pct}%"></div></div>
                    <div class="bar-controls">
                        <button class="bar-btn" onclick="modCustom(${i},-1)">-1</button>
                        <input type="number" class="bar-input" value="${b.c}" onchange="setCustomCurr(${i},this.value)">
                        <button class="bar-btn" onclick="modCustom(${i},1)">+1</button>
                        <input type="number" class="bar-input" value="${b.m}" style="border-color:#666;" onchange="setCustomMax(${i},this.value)">
                    </div>
                </div>`;
        });
    }
}
        function updateAttr(k,v){ getActive().attrs[k]=parseInt(v); }
        function modCurr(t,v){ getActive().stats[t].c+=v; save(); }
        function setCurr(t,v){ getActive().stats[t].c=parseInt(v); save(); }
        function modMax(t,v){ getActive().stats[t].b+=v; save(); }
        
        // Stats Logic
        function updateLevel(v) { getActive().stats.level = parseInt(v); save(); }
        function updateXP(v) { getActive().stats.xp = v; save(); }
        function updateStat(k, v) { getActive().stats[k] = parseInt(v); save(); }

        function addCustomBar() {
            const n = prompt("Nome da Barra (ex: Muni√ß√£o, Sanidade):");
            const m = prompt("Valor M√°ximo:");
            if(n && m) {
                const c = getActive();
                if(!c.customBars) c.customBars = [];
                c.customBars.push({n:n, c:parseInt(m), m:parseInt(m)});
                save(); renderAttrs();
            }
        }
        function removeCustomBar(i) { if(confirm("Remover esta barra?")) { getActive().customBars.splice(i,1); save(); renderAttrs(); } }
        function modCustom(i, v) { getActive().customBars[i].c += v; save(); renderAttrs(); }
        function setCustomCurr(i, v) { getActive().customBars[i].c = parseInt(v); save(); renderAttrs(); }
        function setCustomMax(i, v) { getActive().customBars[i].m = parseInt(v); save(); renderAttrs(); }

        function renderList(type) {
    const c = getActive(); 
    if(!c.lists) c.lists = {}; 
    if(!c.lists[type]) c.lists[type] = []; 
    
    const div = document.getElementById('list-'+type); 
    div.innerHTML = '';
    
    c.lists[type].forEach((item, i) => {
        
        // 1. DEFINIR A IMAGEM DO ITEM (Esquerda)
        // Se tiver foto, usa ela. Se n√£o, usa um √≠cone gen√©rico (ex: inventario.png ou dado.png parado)
        let imgItem = item.img && item.img.length > 5 ? item.img : "pasta.png"; // Pode trocar "dado.png" por um placeholder tipo "item_placeholder.png"

        // 2. PREPARAR DADOS
        const modVal = item.mod || 0; 
        const sign = modVal >= 0 ? '+' : '';
        const starClass = item.fav ? 'fav-active' : 'fav-inactive';

        // 3. MONTAR O CARD
        div.innerHTML += `
        <div class="item-card" onclick="this.classList.toggle('open')">
            
            <div class="card-top">
                <img src="${imgItem}" class="item-thumb" onclick="expandImage('${imgItem}')">

                <b style="flex:1; margin-left:10px; font-size:0.9rem;">${item.n}</b>

                <div style="display:flex; align-items:center;" onclick="event.stopPropagation()">
                    
                    <input type="text" class="mod-input" value="${sign}${modVal}" 
                           style="margin-right: 5px; width: 30px;" 
                           onchange="updateItemMod('${type}', ${i}, this.value)"
                           placeholder="Mod">

                    <button class="btn-roll-dice" onclick="rollItem('${type}', ${i})" title="Rolar">
                        <img src="dado.png" class="roll-icon">
                    </button>
                </div>
            </div>
            
            <div class="item-details">
                <button class="btn-card-action btn-remove" onclick="removeItem(event,'${type}',${i})">Remover</button>
                <button class="btn-card-action btn-edit" onclick="openEditModal(event,'${type}',${i})">Editar</button>
                <button class="btn-card-action btn-fav ${item.fav?'active':''}" onclick="togFav(event,'${type}',${i})">‚òÖ</button>
                
                <p style="font-size:0.8rem; color:#888; margin-top:5px; width:100%; border-top:1px solid #222; padding-top:5px;">
                    ${item.desc||''}
                </p>
            </div>
        </div>`;
    });
}

        function updateItemMod(type, i, val) { 
            getActive().lists[type][i].mod = parseInt(val); 
            clearTimeout(window.saveTimeout);
            window.saveTimeout = setTimeout(() => save(), 1000); 
        }
        function removeItem(e,t,i){ e.stopPropagation(); if(confirm("Remover?")){ getActive().lists[t].splice(i,1); save(); renderList(t); renderFavs(); }}
        function renderFavs() {
    const c = getActive();
    const div = document.getElementById('list-favs');
    div.innerHTML = '';

    // Lista de categorias para procurar favoritos
    ['habilidades', 'pericias', 'oficios', 'equipamentos', 'itens'].forEach(t => {
        // Verifica se a lista existe no personagem
        if (c.lists && c.lists[t]) {
            c.lists[t].forEach((i, idx) => {
                // Se o item for favorito (fav == true)
                if (i.fav) {
                    // AQUI EST√Å A IMAGEM DO DADO
                    // N√£o esque√ßa de trocar a URL abaixo pela sua imagem
                    const hexIcon = `<img src="dado.png" class="dice-img" onclick="event.stopPropagation(); rollItem('${t}', ${idx})">`;

                    // Adiciona o cart√£o na tela (com borda roxa neon)
                    div.innerHTML += `
                        <div class="item-card" style="border-color: var(--neon-purple)">
                            <div class="card-top">
                                ${hexIcon}
                                <b>${i.n}</b>
                            </div>
                            <small>${t.toUpperCase()}</small>
                        </div>`;
                }
            });
        }
    });
}

        function togFav(e,t,i){ e.stopPropagation(); const c=getActive(); c.lists[t][i].fav=!c.lists[t][i].fav; save(); renderList(t); renderFavs(); }

        function openEditModal(e, type, index) {
    e.stopPropagation(); // Impede que o card feche ao clicar no bot√£o
    
    // Define o que estamos editando
    editingList = type; 
    editingIndex = index; 
    
    const item = getActive().lists[type][index];
    
    // Preenche os campos normais
    document.getElementById('ed-name').value = item.n || ''; 
    document.getElementById('ed-dmg').value = item.dmg || ''; 
    document.getElementById('ed-crit').value = item.crit || ''; 
    document.getElementById('ed-type').value = item.type || ''; 
    document.getElementById('ed-range').value = item.range || ''; 
    document.getElementById('ed-notes').value = item.desc || ''; 
    
    // --- PARTE DA IMAGEM (IMPORTANTE) ---
    // Preenche o link da imagem (se tiver)
    document.getElementById('ed-img').value = item.img || '';
    
    // Reseta o visual do bot√£o de upload
    document.getElementById('item-upload-input').value = ""; 
    document.getElementById('lbl-item-upload').innerText = "üìÅ Escolher da Galeria";
    
    // Limpa e recria os campos de Dano Extra
    const extraContainer = document.getElementById('extra-dmg-list'); 
    extraContainer.innerHTML = ''; 
    
    if(item.extraDmg) { 
        item.extraDmg.forEach(ex => { 
            const row = document.createElement('div'); 
            row.className='extra-dmg-row'; 
            row.innerHTML = `
                <input type="text" class="edit-input" placeholder="Dado" value="${ex.dice}">
                <input type="text" class="edit-input" placeholder="Tipo" value="${ex.type}">
                <button class="btn-del-extra" onclick="this.parentElement.remove()">X</button>
            `; 
            extraContainer.appendChild(row); 
        }); 
    } 
    
    // Finalmente, mostra o modal
    document.getElementById('edit-modal').style.display = 'flex'; 
}

        function addExtraDmgField() { 
    const row = document.createElement('div'); 
    row.className='extra-dmg-row'; 
    row.innerHTML = `
        <input type="text" class="edit-input" placeholder="Dado">
        <input type="text" class="edit-input" placeholder="Tipo">
        <button class="btn-del-extra" onclick="this.parentElement.remove()">X</button>
    `; 
    document.getElementById('extra-dmg-list').appendChild(row); 
}

       function saveEdit() { 
    // Pega o item atual
    const item = getActive().lists[editingList][editingIndex]; 
    
    // Salva os valores dos inputs para dentro do item
    item.n = document.getElementById('ed-name').value; 
    item.dmg = document.getElementById('ed-dmg').value; 
    item.crit = document.getElementById('ed-crit').value; 
    item.type = document.getElementById('ed-type').value; 
    item.range = document.getElementById('ed-range').value; 
    item.img = document.getElementById('ed-img').value; // SALVA A IMAGEM
    item.desc = document.getElementById('ed-notes').value; 
    
    // Salva os danos extras
    item.extraDmg = []; 
    document.querySelectorAll('#extra-dmg-list .extra-dmg-row').forEach(row => { 
        const inputs = row.querySelectorAll('input'); 
        if(inputs[0].value) {
            item.extraDmg.push({dice: inputs[0].value, type: inputs[1].value}); 
        }
    }); 
    
    // Salva no banco de dados e atualiza a tela
    save(); 
    renderList(editingList); 
    
    // Fecha o modal
    document.getElementById('edit-modal').style.display = 'none'; 
}

        function openAddModal(type){
            currentAddType = type; 
            document.getElementById('add-modal').style.display='flex';
            const l = document.getElementById('add-list-content'); l.innerHTML='';
            let db = [];
            if(type==='pericias') db = periciasDB;
            else if(type==='oficios') db = oficiosDB;
            else db = generalItemsDB[type] || [];
            
            db.forEach(i => {
                l.innerHTML += `<div class="add-item-row" onclick="addFromList('${i}')">${i}</div>`;
            });
        }

        function addFromList(n){
            const c = getActive();
            if(!c.lists) c.lists = {};
            if(!c.lists[currentAddType]) c.lists[currentAddType] = [];
            c.lists[currentAddType].push({n:n, fav:false, mod:0});
            save();
            renderList(currentAddType);
            document.getElementById('add-modal').style.display='none';
        }

        function addCustomItem(){
            const n = prompt("Nome:");
            if(n){
                const c = getActive();
                if(!c.lists) c.lists = {};
                if(!c.lists[currentAddType]) c.lists[currentAddType] = [];
                c.lists[currentAddType].push({n:n, fav:false, mod:0});
                save();
                renderList(currentAddType);
                document.getElementById('add-modal').style.display='none';
            }
        }
        
        function openSettings(){document.getElementById('settings-modal').style.display='block';}
        function setTheme(c){getActive().color=c;save();renderHome();}
        function setBg(u){getActive().bg=u;save();renderHome();}
        function shareChar(){alert("Link copiado!");}
// --- FUN√á√ÉO DE CAMPANHA (NOVO) ---

function openCampModal() {
    document.getElementById('camp-modal').style.display = 'flex';
    document.getElementById('inp-camp-code').focus();
}

function joinCamp() {
    const code = document.getElementById('inp-camp-code').value.trim();
    if(!code) return alert("Por favor, digite o c√≥digo da sala.");

    // 1. Salva o novo c√≥digo
    roomCode = code;
    localStorage.setItem('rpg_room_code_v14', roomCode);

    // 2. Atualiza visual
    document.getElementById('room-display').innerText = roomCode;

    // 3. Desconecta do Firebase antigo e conecta no novo
    if(dbRef) dbRef.off(); // Para de escutar a sala antiga
    dbRef = db.ref('rpg_rooms/' + roomCode); // Aponta para a nova

    // 4. Recarrega os personagens da nova sala
    dbRef.child('chars').on('value', (snapshot) => {
        const data = snapshot.val();
        chars = data || [];
        renderHome(); // Atualiza a lista na tela inicial
        
        // L√≥gica de "Escolher Personagem":
        // Na v17, ao entrar na sala, voc√™ v√™ todos os personagens daquela sala.
        // Se voc√™ j√° tem um personagem l√°, ele aparece. Se n√£o, voc√™ clica em "+ Novo Agente".
        // Assim que voc√™ criar ou abrir, o Mestre v√™ l√° na tela dele.
    });
    // 5. Reconecta o sistema de rolagens
    dbRef.child('rolls').limitToLast(1).on('child_added', (snapshot) => {
        const r = snapshot.val();
        if(Date.now() - r.id < 5000) { 
            showToast(r);
            rollHistory.push(r); // Opcional: Adicionar ao hist√≥rico
        }
    });

    // Fecha modal e avisa
    document.getElementById('camp-modal').style.display = 'none';
    alert(`Conectado √† campanha: ${roomCode}\nAgora crie seu personagem ou selecione um existente.`);
}
    // --- FUN√á√ÉO VISUAL ROXO NEON ---
    function aplicarEstiloNeon() {
        // Seleciona os bot√µes principais do sistema
        const botoes = document.querySelectorAll('.btn-new, .btn-pick-cls, .btn-save-edit, .btn-wiz-action.primary, .btn-custom-add, #camp-modal button');
        
        botoes.forEach(btn => {
            btn.classList.add('btn-glitch');
            
            // Gera n√∫meros aleat√≥rios para criar o padr√£o √∫nico
            const angulo = Math.floor(Math.random() * 360); // Dire√ß√£o das listras
            const roxoW = Math.floor(Math.random() * 30) + 10; // Tamanho da parte roxa
            const pretoW = Math.floor(Math.random() * 5) + 2;  // Tamanho da linha preta (fundo)
            
            // Aplica um gradiente que mistura o ROXO com a COR DO FUNDO (#050505)
            btn.style.background = `repeating-linear-gradient(
                ${angulo}deg,
                var(--neon-purple),
                var(--neon-purple) ${roxoW}px,
                var(--bg-color) ${roxoW}px,
                var(--bg-color) ${roxoW + pretoW}px
            )`;
        });
    }

    // Chama a fun√ß√£o assim que a p√°gina carrega e quando o sistema atualiza
    window.addEventListener('DOMContentLoaded', aplicarEstiloNeon);
    
    // ATEN√á√ÉO: Adicione a chamada 'aplicarEstiloNeon()' dentro das fun√ß√µes 
    // 'renderHome', 'openAddModal' e 'startWizard' para garantir que 
    // bot√µes novos tamb√©m recebam o efeito.
    // --- FUN√á√ÉO DE UPLOAD DA GALERIA ---
    function uploadImagemGaleria(input) {
        if (input.files && input.files[0]) {
            const arquivo = input.files[0];
            const lbl = document.getElementById('lbl-upload');
            lbl.innerText = "‚åõ Processando...";
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                
                img.onload = function() {
                    // Cria um Canvas para redimensionar a imagem
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Redimensiona para max 800px (para ficar leve)
                    const MAX_WIDTH = 800;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Desenha a imagem nova
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Converte para c√≥digo e salva
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    setBg(dataUrl);
                    
                    // Atualiza visual
                    lbl.innerText = "‚úÖ Foto Definida!";
                    setTimeout(() => lbl.innerText = "üìÅ Escolher da Galeria", 2000);
                    document.getElementById('img-input').value = "(Imagem da Galeria)";
                }
            }
            reader.readAsDataURL(arquivo);
        }
    }

    // Atualize tamb√©m suas fun√ß√µes setTheme e setBg para garantir que atualizem a tela na hora
    function setTheme(c){
        getActive().color=c; 
        save(); 
        renderHome();
        // Atualiza a borda do modal imediatamente para dar feedback visual
        document.querySelector('#settings-modal button').style.background = c;
    }
        function renderGmData() {
        const div = document.getElementById('list-npcs'); // Alvo: Aba de NPCs
        if(!div) return;
        div.innerHTML = '';
        
        // Junta NPCs e Cen√°rios em uma √∫nica lista para o jogador
        const combined = [...npcs, ...cenarios];
        
        if(combined.length === 0) {
            div.innerHTML = '<p style="color:#666; text-align:center; width:100%; margin-top:20px;">Nada revelado pelo Mestre ainda.</p>';
            return;
        }

        combined.forEach(item => {
            const img = (item.img && item.img.length > 20) ? item.img : 'https://via.placeholder.com/150?text=Sem+Foto';
            
            div.innerHTML += `
            <div class="npc-card" style="margin-bottom:15px;">
                <span class="npc-name">${item.name}</span>
                <img src="${img}" class="npc-img" onclick="expandImage('${img}')">
                <div class="npc-desc">${item.desc || ''}</div>
            </div>`;
        });
    }

    // Fun√ß√£o de Zoom (Caso n√£o tenha no seu arquivo)
    function expandImage(src) {
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:9999;display:flex;justify-content:center;align-items:center;';
        modal.onclick = () => modal.remove();
        modal.innerHTML = `<img src="${src}" style="max-width:95%; max-height:90%; border-radius:10px; box-shadow:0 0 30px rgba(176,38,255,0.5);">`;
        document.body.appendChild(modal);
    }


    function setBg(u){
        getActive().bg=u; 
        save(); 
        renderHome();
    }
    // --- FUN√á√ÉO PARA UPLOAD DE IMAGEM DE ITEM ---
    function uploadImagemItem(input) {
        if (input.files && input.files[0]) {
            const arquivo = input.files[0];
            const lbl = document.getElementById('lbl-item-upload');
            lbl.innerText = "‚åõ Processando...";
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Itens s√£o pequenos, ent√£o limitamos a 150px para ficar MUITO leve
                    const MAX_SIZE = 150; 
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                    } else {
                        if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Salva no campo de texto (invis√≠vel ou vis√≠vel)
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    document.getElementById('ed-img').value = dataUrl;
                    
                    // Feedback visual
                    lbl.innerText = "‚úÖ Imagem Pronta!";
                    setTimeout(() => lbl.innerText = "üìÅ Escolher da Galeria", 2000);
                }
            }
            reader.readAsDataURL(arquivo);
        }
    }
function expandImage(src) {
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:9999;display:flex;justify-content:center;align-items:center;';
    modal.onclick = () => modal.remove();
    modal.innerHTML = `<img src="${src}" style="max-width:95%; max-height:90%; border-radius:10px; box-shadow:0 0 30px rgba(176,38,255,0.3);">`;
    document.body.appendChild(modal);
}

    </script>
</body>
</html>